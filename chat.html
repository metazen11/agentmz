<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agentic v2 - Coding Agent</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230F172A'/><path d='M25 50L45 70L80 30' stroke='%2338BDF8' stroke-width='12' fill='none' stroke-linecap='round' stroke-linejoin='round'/><circle cx='80' cy='30' r='8' fill='%23FFF'/></svg>">
<link rel="stylesheet" href="/static/css/base.css">
<link rel="stylesheet" href="/static/css/components.css">
<link rel="stylesheet" href="/static/css/sidebar.css">
<link rel="stylesheet" href="/static/css/chat.css">
<link rel="stylesheet" href="/static/css/logs.css">
<link rel="stylesheet" href="/static/css/forms.css">
<link rel="stylesheet" href="/static/css/integrations.css">
</head>
<body>
<div class="container">
  <h1>Agentic v2</h1>
  <p class="subtitle">Coding agent powered by Ollama + Aider</p>

  <div class="main-layout">
    <!-- Sidebar: Projects and Tasks -->
    <div class="sidebar">
      <div class="sidebar-section-header">
        <h3>Projects</h3>
        <button class="btn-small" onclick="showNewProjectModal()">+ New Project</button>
      </div>
      <ul class="project-list" id="project-list">
        <li>Loading...</li>
      </ul>

      <div class="sidebar-section-header spaced">
        <h3>Tasks</h3>
        <button class="btn-small" onclick="showNewTaskModal()" aria-label="New Task" title="New Task">New</button>
        <button class="btn-small" onclick="showIntegrationWizard()" aria-label="Import Tasks" title="Import Tasks">Import</button>
      </div>
      <ul class="task-list" id="task-list">
        <li style="color: #666;">Select a project</li>
      </ul>

      <div class="file-tree" id="file-tree">
        <div class="file-tree-header">
          <h3>Files</h3>
          <button class="btn-small" onclick="showGitModal()">Git</button>
        </div>
        <div id="file-tree-content">
          <span style="color: #666;">Select a project</span>
        </div>
      </div>
    </div>

    <!-- Main Chat Panel -->
    <div class="chat-panel">
    <div class="status-bar">
      <div id="status" class="status">Checking connection...</div>
      <button id="heal-btn" class="secondary" onclick="runFullHealthCheck(true)">Heal</button>
      <div class="selector model-selector">
        <label for="model-select">Model</label>
        <select id="model-select" disabled>
          <option value="">Loading...</option>
        </select>
        <button id="model-apply" class="secondary" onclick="applyModelSelection()" disabled>Set</button>
      </div>
      <button class="secondary" onclick="showSettingsModal()">Settings</button>
    </div>

      <div id="messages"></div>

      <div id="input-form">
        <textarea id="prompt" placeholder="Ask the agent to edit code..."></textarea>
        <button id="send">Send</button>
      </div>
      <div id="image-dropzone" class="image-dropzone">
        Drag & drop images here, or <button class="btn-small" onclick="openImagePicker()">browse</button>
        <input id="image-input" type="file" accept="image/*" multiple style="display:none;">
      </div>
      <div class="selector vision-selector">
        <label for="vision-model-select">Vision</label>
        <select id="vision-model-select" disabled>
          <option value="">Loading...</option>
        </select>
      </div>
      <div id="image-list" class="image-list"></div>

    </div>
  </div>

  <!-- Logs Panel -->
  <div class="logs-panel">
    <div class="logs-header" onclick="toggleLogs()">
      <div style="display: flex; align-items: center;">
        <h3>Container Logs</h3>
        <span id="logs-connection" class="connection-status disconnected">disconnected</span>
      </div>
      <div class="logs-tabs" onclick="event.stopPropagation()">
        <button id="tab-ollama_http" class="active" onclick="switchLogTab('ollama_http')">Ollama HTTP</button>
        <button id="tab-ollama" onclick="switchLogTab('ollama')">Ollama</button>
        <button id="tab-aider" onclick="switchLogTab('aider')">Aider</button>
        <button id="tab-main" onclick="switchLogTab('main')">Main API</button>
      </div>
    </div>
    <div id="logs-content" class="logs-content">
      <div id="log-pane-ollama_http" class="log-pane"></div>
      <div id="log-pane-ollama" class="log-pane" style="display:none;"></div>
      <div id="log-pane-aider" class="log-pane" style="display:none;"></div>
      <div id="log-pane-main" class="log-pane" style="display:none;"></div>
    </div>
  </div>
</div>

<div id="tooltip-layer" class="tooltip-layer">
  <div id="global-tooltip" class="tooltip"></div>
</div>

<!-- New Project Modal -->
<div id="new-project-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>New Project</h3>
    <label style="font-size:12px; color:#aaa;">Name</label>
    <input type="text" id="new-project-name" placeholder="Project name">
    <label style="font-size:12px; color:#aaa; margin-top:8px;">Workspace (folder name in /workspaces/)</label>
    <input type="text" id="new-project-workspace" placeholder="e.g. poc, my_app">
    <div class="modal-actions">
      <button onclick="createProject()">Create</button>
      <button class="secondary" onclick="hideModals()">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Project Modal -->
<div id="edit-project-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Edit Project</h3>
    <label style="font-size:12px; color:#aaa;">Name</label>
    <input type="text" id="edit-project-name" placeholder="Project name">
    <label style="font-size:12px; color:#aaa; margin-top:8px;">Workspace (folder name only, e.g. poc)</label>
    <input type="text" id="edit-project-workspace" placeholder="e.g. poc, beatbridge_app">
    <label style="font-size:12px; color:#aaa; margin-top:8px;">Environment</label>
    <input type="text" id="edit-project-environment" placeholder="e.g. local">
    <div class="modal-actions">
      <button onclick="updateProject()">Save</button>
      <button class="secondary" onclick="hideModals()">Cancel</button>
    </div>
  </div>
</div>

<!-- New Task Modal -->
<div id="new-task-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>New Task</h3>
    <input type="text" id="new-task-title" placeholder="Task title">
    <textarea id="new-task-desc" placeholder="Description (optional)"></textarea>
    <div id="new-task-parent-row">
      <label style="font-size:12px; color:#aaa; margin-top:8px;">Parent Task (optional)</label>
      <select id="new-task-parent-id">
        <option value="">No parent</option>
      </select>
    </div>
    <label style="font-size:12px; color:#aaa; margin-top:8px;">Node</label>
    <select id="new-task-node">
      <option value="">Loading...</option>
    </select>
    <label style="font-size:12px; color:#aaa; margin-top:8px;">Status</label>
    <select id="new-task-status">
      <option value="backlog">backlog</option>
      <option value="in_progress">in_progress</option>
      <option value="done">done</option>
      <option value="failed">failed</option>
    </select>
    <div class="details-panel">
      <div class="details-title">Acceptance Criteria</div>
      <div id="new-task-criteria-list" class="criteria-list">No criteria</div>
      <input type="text" id="new-criteria-desc" placeholder="Add acceptance criteria">
      <div class="comment-actions">
        <button onclick="addNewTaskCriteria()">Add Criteria</button>
      </div>
    </div>
    <div class="modal-actions">
      <button onclick="createTask()">Create</button>
      <button class="secondary" onclick="hideModals()">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Task Modal -->
<div id="edit-task-modal" class="modal" style="display:none;">
  <div class="modal-content task-modal-content">
    <div class="modal-header">
      <h3>Edit Task</h3>
      <button class="btn-small secondary" onclick="hideModals()" aria-label="Close">×</button>
    </div>
    <input type="text" id="edit-task-title" placeholder="Task title">
    <textarea id="edit-task-desc" placeholder="Description (optional)"></textarea>
    <div id="edit-task-parent-row" class="task-parent-row" style="display:none;">
      Parent: <a href="#" id="edit-task-parent-link"></a>
    </div>
    <label style="font-size:12px; color:#aaa; margin-top:8px;">Node</label>
    <select id="edit-task-node">
      <option value="">Loading...</option>
    </select>
    <label style="font-size:12px; color:#aaa; margin-top:8px;">Status</label>
    <select id="edit-task-status">
      <option value="backlog">backlog</option>
      <option value="in_progress">in_progress</option>
      <option value="done">done</option>
      <option value="failed">failed</option>
    </select>

    <div class="details-panel">
      <div class="details-title">Acceptance Criteria</div>
      <div id="task-criteria-list" class="criteria-list">No criteria</div>
      <input type="text" id="criteria-desc" placeholder="Add acceptance criteria">
      <input type="text" id="criteria-author" placeholder="Author (optional)">
      <div class="comment-actions">
        <button onclick="addAcceptanceCriteria()">Add Criteria</button>
      </div>
    </div>

    <div class="details-panel">
      <div class="details-title-row">
        <div class="details-title">Subtasks</div>
        <button class="btn-small" onclick="createSubtask(getEditingTaskId())">+ Add Subtask</button>
      </div>
      <div id="subtask-list" class="subtask-list">No subtasks</div>
    </div>

    <div class="details-panel">
      <div class="details-title">Comments</div>
      <div id="task-comments-list" class="comment-list">No comments</div>
      <input type="text" id="comment-author" placeholder="Author (optional)">
      <textarea id="comment-body" placeholder="Add a comment"></textarea>
      <input type="hidden" id="comment-id">
      <div class="comment-actions">
        <button onclick="saveTaskComment()">Save Comment</button>
        <button class="secondary" onclick="resetCommentForm()">Cancel</button>
      </div>
    </div>

    <div class="details-panel">
      <div class="details-title">Attachments</div>
      <div id="task-attachments-list" class="attachment-list">No attachments</div>
      <input type="file" id="attachment-file">
      <input type="text" id="attachment-uploaded-by" placeholder="Uploaded by (optional)">
      <select id="attachment-comment-id">
        <option value="">Attach to task</option>
      </select>
      <div class="comment-actions">
        <button onclick="uploadTaskAttachment()">Upload</button>
      </div>
    </div>

    <div class="details-panel">
      <div class="details-title">Run Preview</div>
      <textarea id="task-run-preview" class="preview-textarea" readonly
                placeholder="Build prompt to preview the run context"></textarea>
      <div class="comment-actions">
        <button onclick="buildTaskPromptPreview(this)">Build Prompt</button>
      </div>
    </div>

    <div class="details-panel">
      <div class="details-title">Runs</div>
      <div id="task-runs-list" class="run-list">No runs yet</div>
    </div>

    <div class="modal-actions">
      <button onclick="updateTask()">Save</button>
      <button class="delete" onclick="deleteTask(getEditingTaskId())">Delete</button>
      <button class="secondary" onclick="hideModals()">Cancel</button>
      <button class="secondary" onclick="hideModals()">Close</button>
      <button id="edit-task-run-btn" class="secondary run-task-btn"
              onclick="runTaskFromModal(getEditingTaskId())">Run</button>
    </div>
  </div>
</div>

<!-- Git Modal -->
<div id="git-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Git</h3>
    <div class="git-modal-grid">
      <div class="git-meta" id="git-current-branch">Current branch: -</div>
      <div class="git-meta" id="git-user-config">User: -</div>
      <div class="git-row">
        <button onclick="initGitRepo()">Init Repo</button>
      </div>
      <div class="git-row">
        <input id="git-user-name" type="text" placeholder="user.name">
        <input id="git-user-email" type="text" placeholder="user.email">
        <button onclick="saveGitUser()">Save User</button>
      </div>
      <div class="git-row">
        <select id="git-branch-select" disabled>
          <option value="">No repo</option>
        </select>
        <button onclick="checkoutBranch()">Checkout</button>
      </div>
      <div class="git-row">
        <input id="git-branch-input" type="text" placeholder="new branch name">
        <button onclick="createBranch()">Create</button>
      </div>
      <div class="git-row">
        <select id="git-remote-select" disabled>
          <option value="">No remotes</option>
        </select>
        <button onclick="pullBranch()">Pull</button>
        <button onclick="pushBranch()">Push</button>
      </div>
      <div class="git-row">
        <input id="git-remote-name" type="text" placeholder="remote name">
        <input id="git-remote-url" type="text" placeholder="remote url">
        <button onclick="addRemote()">Add Remote</button>
      </div>
      <div class="git-remote-list" id="git-remote-list">No remotes</div>
      <div class="git-log" id="git-log">Git output will appear here...</div>
      <div class="modal-actions">
        <button class="secondary" onclick="hideGitModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal" style="display:none;">
  <div class="modal-content" style="min-width: 600px;">
    <div class="modal-header">
      <h3>Settings</h3>
      <button class="secondary" onclick="hideSettingsModal()" style="padding: 4px 10px;">×</button>
    </div>

    <!-- Tab Navigation -->
    <div class="settings-tabs">
      <button class="settings-tab active" onclick="switchSettingsTab('env')" data-tab="env">Environment</button>
      <button class="settings-tab" onclick="switchSettingsTab('nodes')" data-tab="nodes">Nodes</button>
    </div>

    <!-- Environment Tab Content -->
    <div id="settings-tab-env" class="settings-tab-content active">
      <div class="settings-modal-grid">
        <input id="settings-filter" type="text" placeholder="Filter settings...">
        <div class="settings-list" id="settings-list">Loading...</div>
        <div class="git-row">
          <label><input type="checkbox" id="restart-main" checked> Restart main</label>
          <label><input type="checkbox" id="restart-aider" checked> Restart aider</label>
          <label><input type="checkbox" id="restart-ollama"> Restart ollama</label>
          <label><input type="checkbox" id="restart-db"> Restart db</label>
        </div>
        <div class="modal-actions">
          <button onclick="applySettings()">Apply</button>
        </div>
      </div>
    </div>

    <!-- Nodes Tab Content -->
    <div id="settings-tab-nodes" class="settings-tab-content">
      <div class="node-editor-grid">
        <!-- Node List (Left Panel) -->
        <div class="node-list-container">
          <div class="node-list" id="node-list">Loading...</div>
          <button class="node-add-btn" onclick="createNewNode()">+ New Node</button>
        </div>

        <!-- Node Editor (Right Panel) -->
        <div id="node-editor-panel">
          <div class="node-editor-placeholder">Select a node to edit</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Integration Wizard Modal -->
<div id="integration-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 style="margin:0;">Import External Tasks</h3>
      <button class="btn-small secondary" onclick="window.integrationModule.hideIntegrationWizard()">×</button>
    </div>
    <div id="integration-error"></div>
    <div id="integration-content">
      <p>Loading...</p>
    </div>
  </div>
</div>

<script type="module" src="/static/js/main.js"></script>
</body>
</html>
